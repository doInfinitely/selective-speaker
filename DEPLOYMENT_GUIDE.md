# Production Deployment Guide

## Pre-Deployment Checklist

✅ Backend authentication implemented  
✅ User isolation enforced  
✅ Cloudinary storage configured  
✅ Requirements.txt updated  
✅ Procfile created  

## Required Accounts

1. **Railway** or **Render** - Backend hosting
2. **Cloudinary** - Audio file storage
3. **Firebase** - Authentication
4. **AssemblyAI** - Transcription (already have)
5. **HuggingFace** - Speaker embeddings (already have)

---

## Step 1: Set Up Cloudinary

Follow `CLOUDINARY_SETUP.md` to:
1. Create account
2. Get credentials (Cloud Name, API Key, API Secret)
3. Keep these for Step 3

---

## Step 2: Set Up Firebase Project

Follow `FIREBASE_SETUP.md` to:
1. Create Firebase project
2. Enable Authentication
3. Download service account JSON
4. Get Android `google-services.json`

---

## Step 3: Deploy to Railway (Recommended)

### 3.1. Create Railway Account

1. Go to [https://railway.app](https://railway.app)
2. Sign up with GitHub
3. **Don't deploy yet** - set up first

### 3.2. Create New Project

1. Click "New Project"
2. Select "Deploy from GitHub repo"
3. Connect your `selective-speaker` repository
4. Railway will detect it's a Python app

### 3.3. Add PostgreSQL Database

1. In your project, click "New"
2. Select "Database" → "PostgreSQL"
3. Railway will create a database and provide `DATABASE_URL`

### 3.4. Configure Environment Variables

In Railway project settings → Variables, add:

```bash
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://...  # Already set

# Environment
ENV=production

# AssemblyAI
ASSEMBLYAI_API_KEY=your_assemblyai_key
ASSEMBLYAI_WEBHOOK_SECRET=your_webhook_secret
WEBHOOK_BASE_URL=https://your-app.up.railway.app

# Audio Settings
AUDIO_SAMPLE_RATE=16000
AUDIO_CHANNELS=1

# HuggingFace
HUGGINGFACE_TOKEN=your_hf_token

# Cloudinary
USE_CLOUDINARY=true
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_cloudinary_api_key
CLOUDINARY_API_SECRET=your_cloudinary_api_secret
CLOUDINARY_FOLDER=selective-speaker

# Firebase (will add after upload)
FIREBASE_SERVICE_ACCOUNT_KEY=/app/firebase-service-account.json
```

### 3.5. Upload Firebase Service Account

Railway doesn't support file uploads through UI, so we'll use a workaround:

**Option A: Base64 encode in env var**
```bash
# On your machine:
base64 firebase-service-account.json | tr -d '\n' > firebase-key-base64.txt

# Add to Railway as:
FIREBASE_SERVICE_ACCOUNT_BASE64=<paste-base64-string>
```

Then update `app/services/firebase_auth.py` to decode from base64.

**Option B: Commit to private repo** (not recommended)
```bash
# Add to .gitignore exception
!firebase-service-account.json

# Commit and push
```

### 3.6. Deploy!

1. Railway will automatically deploy on push
2. Check logs for any errors
3. Note your deployment URL: `https://your-app.up.railway.app`

### 3.7. Update Webhook URL in AssemblyAI

1. Update `WEBHOOK_BASE_URL` in Railway to your actual URL
2. Redeploy if needed

---

## Step 4: Alternative - Deploy to Render

### 4.1. Create Render Account

1. Go to [https://render.com](https://render.com)
2. Sign up with GitHub

### 4.2. Create Web Service

1. New → Web Service
2. Connect repository
3. Settings:
   - **Name**: selective-speaker-api
   - **Environment**: Python 3
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`
   - **Instance Type**: Free (or Starter for better performance)

### 4.3. Add PostgreSQL

1. New → PostgreSQL
2. Name it, select free tier
3. Copy the "Internal Database URL"
4. Add as `DATABASE_URL` in web service environment variables

### 4.4. Set Environment Variables

Same as Railway (Step 3.4), but in Render's Environment tab

### 4.5. Deploy

Render will automatically deploy. Check logs.

---

## Step 5: Verify Deployment

### 5.1. Health Check

```bash
curl https://your-app.railway.app/health
# Should return: {"status":"healthy"}
```

### 5.2. Test Enrollment (without auth for now)

```bash
# This will fail with 401 if auth is working
curl https://your-app.railway.app/enrollment/status
```

---

## Step 6: Add Firebase to Android App

See `FIREBASE_SETUP.md` for Android integration:
1. Add `google-services.json` to `android/app/`
2. Implement sign-in flow
3. Send auth tokens with requests

---

## Step 7: Update Android App with Production URL

In `android/app/build.gradle.kts`:

```kotlin
buildConfigField("String", "API_BASE_URL", "\"https://your-app.railway.app\"")
```

Rebuild and test!

---

## Cost Breakdown (Monthly)

| Service | Tier | Cost |
|---------|------|------|
| Railway | Hobby | $5/month |
| Cloudinary | Free | $0 (25GB) |
| Firebase | Spark | $0 (generous limits) |
| AssemblyAI | Pay-as-you-go | ~$0.25/hour of audio |
| HuggingFace | Free | $0 |
| **Total** | | **~$5-10/month** |

---

## Troubleshooting

### Database Connection Errors

Railway/Render automatically provides `DATABASE_URL`. If you see connection errors:

1. Check if PostgreSQL addon is created
2. Verify `DATABASE_URL` is set
3. Check logs for specific error

### Firebase Auth Not Working

1. Verify service account JSON is accessible
2. Check Firebase console for enabled auth methods
3. Ensure Android app has correct `google-services.json`

### Cloudinary Upload Fails

1. Verify credentials are correct
2. Check `USE_CLOUDINARY=true` in production
3. Look at error logs for specific issue

### AssemblyAI Webhook Not Received

1. Verify `WEBHOOK_BASE_URL` matches your actual domain
2. Check Railway/Render logs for incoming webhook requests
3. Test webhook manually: `curl -X POST https://your-app/webhooks/assemblyai`

---

## Monitoring & Logs

### Railway
- Click on your service
- View "Deployments" tab for logs
- Use `railway logs` CLI command

### Render
- Go to your web service
- Click "Logs" tab
- Real-time log streaming

---

## Next Steps After Deployment

1. Test full flow: Enroll → Record → View transcripts
2. Monitor costs and usage
3. Set up error alerting (Sentry, etc.)
4. Consider adding analytics
5. Plan for scaling if needed

---

## Need Help?

Common issues and solutions in `TROUBLESHOOTING.md` (create if needed!)

